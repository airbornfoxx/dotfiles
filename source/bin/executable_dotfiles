#!/bin/bash

DOTFILES_REPO=$HOME/.dotfiles
DOTFILES_CONFIG_PATH=$HOME/.config/dotfiles/dotfiles.toml

HOMEBREW=$DOTFILES_REPO/homebrew
MACOS=$DOTFILES_REPO/macos

set -e

displayUsageAndExit() {
    echo ""
    echo "dotfiles - Manage dotfiles, install/update software, and setup MacOS preferences."
    echo ""
    echo "Usage: dotfiles [command]"
    echo ""
    echo "Commands:"
    echo "  [chezmoi]         Manage dotfiles using chezmoi"
    echo "  install rosetta   Install Rosetta"
    echo "  install bundle    Install Homebrew bundle"
    echo "  update brew       Update Homebrew software (formulae/casks)"
    echo "  macos dock        Setup MacOS Dock"
    exit
}

progressMessage() {
    printf "\r\033[00;34m$@\033[0m\n"
}

installRosetta() {
    if ! /usr/bin/pgrep oahd >/dev/null 2>&1; then
        progressMessage "Installing Rosetta..."
        $MACOS/install-rosetta.sh
    else
        progressMessage "Rosetta already installed"
    fi
}

installHomebrew() {
    if test ! $(which brew); then
        progressMessage "Installing Homebrew..."
        $HOMEBREW/install-homebrew.sh
    fi
}

installHomebrewBundle() {
    installHomebrew
    progressMessage "Installing dependencies from the Brewfile..."
    $HOMEBREW/install-bundle.sh
}

updateHomebrew() {
    installHomebrew
    progressMessage "Updating Homebrew formulae and casks..."
    $HOMEBREW/update-homebrew.sh
}

setupDock() {
    progressMessage "Setting up Dock..."
    $MACOS/setup-dock.sh
}

runChezmoi() {
    chezmoi -c $DOTFILES_CONFIG_PATH $@
}

case "$1" in
    install)
        case "$2" in
            rosetta)
                installRosetta
                ;;
            bundle)
                installHomebrewBundle
        esac
        ;;
    update)
        case "$2" in
            brew)
                updateHomebrew
                ;;
            *)
                runChezmoi $@
                ;;
        esac
        ;;
    macos)
        case "$2" in
            dock)
                setupDock
                ;;
        esac
        ;;
    help)
        displayUsageAndExit
        ;;
    *)
        if [ -z "$1" ]; then
            displayUsageAndExit
        fi
        runChezmoi $@
        ;;
esac
