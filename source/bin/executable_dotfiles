#!/bin/bash

DOTFILES_REPO=$HOME/.dotfiles
DOTFILES_CONFIG_PATH=$HOME/.config/dotfiles/dotfiles.toml

HOMEBREW=$DOTFILES_REPO/homebrew
MACOS=$DOTFILES_REPO/macos

set -e

displayUsageAndExit() {
    echo ""
    echo "dotfiles - Manage dotfiles, install/update software, and setup MacOS preferences."
    echo ""
    echo "Usage: dotfiles [command]"
    echo ""
    echo "Commands:"
    echo "  [chezmoi]         Manage dotfiles using chezmoi"
    echo "  install rosetta   Install Rosetta"
    echo "  install bundle    Install Homebrew bundle"
    echo "  edit bundle       Edit Homebrew bundle"
    echo "  update all        Update all software (System/Homebrew/AppStore)"
    echo "  update system     Update MacOS system software"
    echo "  update brew       Update Homebrew software (formulae/casks)"
    echo "  update appstore   Update App Store software"
    echo "  macos dock        Setup MacOS Dock"
    echo "  macos defaults    Apply MacOS Defaults"
    exit
}

startMessage() {
    printf "\r\033[00;36m$@\033[0m\n"
}

progressMessage() {
    printf "\r\033[00;34m$@\033[0m\n"
}

successMessage() {
    printf "\r[ \033[00;32mOK\033[0m ] $@\n"
}

installRosetta() {
    if ! /usr/bin/pgrep oahd >/dev/null 2>&1; then
        progressMessage "Installing Rosetta..."
        $MACOS/install-rosetta.sh
    else
        progressMessage "Rosetta already installed"
    fi
}

installHomebrew() {
    if test ! $(which brew); then
        progressMessage "Installing Homebrew..."
        $HOMEBREW/install-homebrew.sh
    fi
}

installHomebrewBundle() {
    installHomebrew
    progressMessage "Installing dependencies from the Brewfile..."
    $HOMEBREW/install-bundle.sh
}

updateAllSoftware() {
    startMessage "Updating all software..."
    updateSystemSoftware
    updateHomebrewSoftware
    updateAppStoreSoftware
    successMessage "All software has been updated."
}

updateSystemSoftware() {
    progressMessage "Checking for system updates..."
    $MACOS/update-system.sh
}

updateHomebrewSoftware() {
    installHomebrew
    progressMessage "Updating Homebrew formulae and casks..."
    $HOMEBREW/update-homebrew.sh
}

updateAppStoreSoftware() {
    progressMessage "Checking for App Store updates..."
    $MACOS/update-appstore.sh
}

setupDock() {
    progressMessage "Setting up Dock..."
    $MACOS/setup-dock.sh
}

applyMacOSDefaults() {
    progressMessage "Applying macOS Defaults..."
    $MACOS/apply-defaults.sh
}

runChezmoi() {
    chezmoi -c $DOTFILES_CONFIG_PATH $@
}

case "$1" in
    install)
        case "$2" in
            rosetta)
                installRosetta
                ;;
            bundle)
                installHomebrewBundle
        esac
        ;;
    edit)
        case "$2" in
            bundle)
                vim $HOMEBREW/Brewfile
                ;;
        esac
        ;;
    update)
        case "$2" in
            all)
                updateAllSoftware
                ;;
            system)
                updateSystemSoftware
                ;;
            brew)
                updateHomebrewSoftware
                ;;
            appstore)
                updateAppStoreSoftware
                ;;
            *)
                runChezmoi $@
                ;;
        esac
        ;;
    macos)
        case "$2" in
            dock)
                setupDock
                ;;
            defaults)
                applyMacOSDefaults
                ;;
        esac
        ;;
    help)
        displayUsageAndExit
        ;;
    *)
        if [ -z "$1" ]; then
            displayUsageAndExit
        fi
        runChezmoi $@
        ;;
esac
